<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play DOOM in Browser</title>
    <style>
        .dosbox-container {
            width: 640px;
            height: 480px;
            border: 1px solid black;
        }
        .error-log {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <h1>Play DOOM in Browser</h1>
    
    <!-- DOSBox container -->
    <div id="dosbox" class="dosbox-container"></div>
    
    <!-- Fullscreen button -->
    <button id="fullscreenBtn">Fullscreen</button>

    <!-- Error log section -->
    <div id="errorLog" class="error-log" style="display: none;">
        <h3>Error Log:</h3>
        <ul id="errorMessages"></ul>
    </div>

    <!-- Load js-dos API -->
    <script src="https://js-dos.com/cdn/js-dos-api.js"></script>

    <script>
        // Fullscreen function
        document.getElementById('fullscreenBtn').addEventListener('click', function () {
            const dosbox = document.getElementById('dosbox');
            if (dosbox.requestFullscreen) {
                dosbox.requestFullscreen();
            } else if (dosbox.mozRequestFullScreen) { // Firefox
                dosbox.mozRequestFullScreen();
            } else if (dosbox.webkitRequestFullscreen) { // Chrome, Safari and Opera
                dosbox.webkitRequestFullscreen();
            } else if (dosbox.msRequestFullscreen) { // IE/Edge
                dosbox.msRequestFullscreen();
            }
        });

        // Display errors in the Error Log section
        function displayError(message) {
            const errorLog = document.getElementById('errorLog');
            const errorMessages = document.getElementById('errorMessages');
            const errorItem = document.createElement('li');
            errorItem.textContent = message;
            errorMessages.appendChild(errorItem);
            errorLog.style.display = 'block';
        }

        // Initialize Dosbox and set up the game
        const dosbox = new Dosbox({
            id: "dosbox",
            onload: function (dosbox) {
                // Run the game from the ZIP file and mount it
                console.log("DOSBox loaded, attempting to run DOOM...");
                try {
                    dosbox.run("https://raw.githubusercontent.com/BussinBuford/gamedev2024/main/DOOM.zip", "./DOOM");
                    console.log("Game files are loading...");
                } catch (error) {
                    displayError("Error loading game files: " + error.message);
                }
            },
            onrun: function (dosbox, app) {
                // Manually start doom.exe after loading
                console.log("App '" + app + "' is running.");
                try {
                    dosbox.sendCommand("doom.exe\n");
                    console.log("Successfully sent 'doom.exe' command.");
                } catch (error) {
                    displayError("Error running 'doom.exe': " + error.message);
                }
            },
            onerror: function (error) {
                displayError("Error initializing Dosbox: " + error.message);
            }
        });

        // Debugging: log exit status and error handling
        window.addEventListener("error", function (e) {
            displayError("Unhandled error: " + e.message);
        });

        // Handle specific exit status like exit(101)
        window.addEventListener("unhandledrejection", function (event) {
            displayError("Unhandled promise rejection: " + event.reason);
        });
    </script>
</body>
</html>
